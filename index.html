<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planetary Restoration Learning System | Comprehensive Edition</title>
    <meta name="description" content="Comprehensive interactive learning platform for planetary stewardship and ecological restoration">
    
    <style>
        /* BASE STYLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-card: #242942;
            --text-primary: #e0e7ff;
            --text-secondary: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --border-color: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-heading: 'Georgia', serif;
        }
        
        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #f8fafc;
                --bg-secondary: #e2e8f0;
                --bg-card: #ffffff;
                --text-primary: #1e293b;
                --text-secondary: #475569;
                --border-color: #cbd5e1;
                --shadow: rgba(0, 0, 0, 0.1);
            }
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* PARALLAX BACKGROUND */
        #parallax-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        #constellation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* GAMIFICATION HUD */
        #hud-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%);
            padding: var(--spacing-md);
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }
        
        .hud-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: var(--spacing-md);
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .xp-bar {
            height: 24px;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }
        
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.5s ease;
        }
        
        .level-badge, .streak-counter {
            background: var(--bg-card);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 20px;
            border: 2px solid var(--accent-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.9rem;
        }
        
        .level-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* HEADER */
        header {
            background: var(--bg-secondary);
            padding: var(--spacing-lg);
            text-align: center;
            margin-top: 90px;
            border-bottom: 2px solid var(--border-color);
        }
        
        h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: var(--spacing-sm);
        }
        
        /* NAVIGATION */
        nav {
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            display: flex;
            justify-content: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            position: sticky;
            top: 90px;
            z-index: 900;
        }
        
        .nav-btn, .theme-btn, .lang-btn, .export-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover, .theme-btn:hover, .lang-btn:hover, .export-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: var(--accent-primary);
            color: white;
        }
        
        /* MAIN CONTENT */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }
        
        #search-input {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: var(--spacing-lg);
        }
        
        /* QUEST PANEL */
        .quest-panel {
            background: var(--bg-card);
            border: 2px solid var(--accent-warning);
            border-radius: 12px;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }
        
        .quest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: var(--spacing-sm);
        }
        
        /* TEACHER PANEL */
        .teacher-customization {
            background: var(--bg-card);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }
        
        .teacher-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        
        .teacher-btn {
            background: var(--accent-secondary);
            color: white;
            border: none;
            padding: var(--spacing-md);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .teacher-btn:hover {
            transform: scale(1.05);
        }
        
        /* MODULES */
        .module {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .module:hover {
            box-shadow: 0 8px 24px var(--shadow);
        }
        
        .module-header {
            padding: var(--spacing-lg);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
        }
        
        .module-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex: 1;
        }
        
        .module-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
        }
        
        .module-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }
        
        .chevron {
            transition: transform 0.3s ease;
            font-size: 1.5rem;
        }
        
        .module.expanded .chevron {
            transform: rotate(180deg);
        }
        
        .module-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }
        
        .module.expanded .module-content {
            max-height: 10000px;
        }
        
        .module-body {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }
        
        .lesson {
            background: var(--bg-secondary);
            padding: var(--spacing-lg);
            border-radius: 8px;
            margin-bottom: var(--spacing-lg);
            border-left: 4px solid var(--accent-primary);
        }
        
        .lesson h4 {
            font-size: 1.2rem;
            margin-bottom: var(--spacing-md);
            color: var(--accent-primary);
        }
        
        .lesson-section {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }
        
        .lesson-section h5 {
            color: var(--accent-secondary);
            margin-bottom: var(--spacing-sm);
            font-size: 1rem;
        }
        
        .lesson-section ul, .lesson-section ol {
            margin-left: var(--spacing-lg);
            margin-top: var(--spacing-sm);
        }
        
        .lesson-section li {
            margin-bottom: var(--spacing-sm);
            line-height: 1.7;
        }
        
        .implementation-steps {
            background: rgba(59, 130, 246, 0.1);
            padding: var(--spacing-md);
            border-radius: 8px;
            margin-top: var(--spacing-sm);
        }
        
        .tools-resources {
            background: rgba(139, 92, 246, 0.1);
            padding: var(--spacing-md);
            border-radius: 8px;
            margin-top: var(--spacing-sm);
        }
        
        .resource-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .resource-link:hover {
            text-decoration: underline;
        }
        
        .key-terms {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .key-term {
            background: var(--accent-primary);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .quiz-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 8px;
            cursor: pointer;
            margin-top: var(--spacing-md);
            transition: all 0.2s ease;
            font-size: 1rem;
        }
        
        .quiz-btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }
        
        /* QUIZ MODAL */
        .quiz-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }
        
        .quiz-modal.active {
            display: flex;
        }
        
        .quiz-container {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow);
        }
        
        .quiz-header {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            padding: var(--spacing-lg);
            color: white;
            border-radius: 14px 14px 0 0;
        }
        
        .quiz-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            margin-top: var(--spacing-md);
            overflow: hidden;
        }
        
        .quiz-progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s ease;
        }
        
        .quiz-body {
            padding: var(--spacing-xl);
        }
        
        .question-text {
            font-size: 1.2rem;
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }
        
        .quiz-option {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            padding: var(--spacing-md);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: var(--spacing-sm);
            transition: all 0.2s ease;
        }
        
        .quiz-option:hover:not(.disabled) {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }
        
        .quiz-option.selected {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .quiz-option.correct {
            background: var(--accent-success);
            color: white;
            border-color: var(--accent-success);
        }
        
        .quiz-option.incorrect {
            background: var(--accent-danger);
            color: white;
            border-color: var(--accent-danger);
        }
        
        .quiz-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .quiz-feedback {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            border-radius: 8px;
            display: none;
        }
        
        .quiz-feedback.show {
            display: block;
        }
        
        .quiz-feedback.correct {
            background: var(--accent-success);
            color: white;
        }
        
        .quiz-feedback.incorrect {
            background: var(--accent-danger);
            color: white;
        }
        
        .quiz-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }
        
        .quiz-btn-primary, .quiz-btn-secondary {
            flex: 1;
            padding: var(--spacing-md);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .quiz-btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .quiz-btn-primary:hover:not(:disabled) {
            background: var(--accent-secondary);
        }
        
        .quiz-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quiz-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        .quiz-results {
            display: none;
            text-align: center;
            padding: var(--spacing-xl);
        }
        
        .quiz-results.show {
            display: block;
        }
        
        .quiz-score {
            font-size: 4rem;
            font-weight: bold;
            margin: var(--spacing-lg) 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* FOOTER */
        footer {
            background: var(--bg-secondary);
            padding: var(--spacing-xl);
            margin-top: var(--spacing-xl);
            border-top: 2px solid var(--border-color);
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        @media (max-width: 768px) {
            .hud-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .module-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div id="parallax-container">
        <canvas id="constellation-canvas"></canvas>
    </div>
    
    <div id="hud-container">
        <div class="hud-grid">
            <div class="xp-bar-container">
                <div style="font-size: 0.85rem; margin-bottom: 4px; color: var(--text-secondary);">
                    <span id="xp-text">0 / 100 XP</span> ‚Ä¢ <span id="next-level">Next: Level 2</span>
                </div>
                <div class="xp-bar">
                    <div class="xp-fill" id="xp-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="level-badge">
                <div class="level-icon" id="level-icon">üå±</div>
                <div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary);">Level</div>
                    <div id="level-number" style="font-weight: bold;">1</div>
                </div>
            </div>
            <div class="streak-counter">
                <span>üî•</span>
                <div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary);">Streak</div>
                    <div id="streak-days" style="font-weight: bold;">0 days</div>
                </div>
            </div>
        </div>
    </div>
    
    <header>
        <h1>üåç Planetary Restoration Learning System</h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem;">Comprehensive Guide to Ecological Stewardship</p>
    </header>
    
    <nav>
        <button class="nav-btn active" onclick="filterModules('all')">All Modules</button>
        <button class="nav-btn" onclick="filterModules('beginner')">Beginner</button>
        <button class="nav-btn" onclick="filterModules('intermediate')">Intermediate</button>
        <button class="nav-btn" onclick="filterModules('advanced')">Advanced</button>
        <select class="lang-btn" id="lang-selector" onchange="changeLanguage(this.value)">
            <option value="en">üá¨üáß English</option>
            <option value="es">üá™üá∏ Espa√±ol</option>
            <option value="fr">üá´üá∑ Fran√ßais</option>
        </select>
        <button class="export-btn" onclick="exportHTML()">üíæ Save HTML</button>
        <button class="export-btn" onclick="window.print()">üñ®Ô∏è Print</button>
    </nav>
    
    <main>
        <input type="text" id="search-input" placeholder="üîç Search modules, lessons, strategies, tools...">
        
        <div class="quest-panel">
            <h2>üéØ Daily Learning Goals</h2>
            <div class="quest-item">
                <span>‚úÖ Complete one comprehensive lesson</span>
                <span style="background: var(--accent-warning); padding: 4px 12px; border-radius: 12px; font-weight: bold;">+50 XP</span>
            </div>
            <div class="quest-item">
                <span>üî• Maintain your learning streak</span>
                <span style="background: var(--accent-warning); padding: 4px 12px; border-radius: 12px; font-weight: bold;">+25 XP</span>
            </div>
            <div class="quest-item">
                <span>üß† Score 80%+ on a practice quiz</span>
                <span style="background: var(--accent-warning); padding: 4px 12px; border-radius: 12px; font-weight: bold;">+75 XP</span>
            </div>
        </div>
        
        <div class="teacher-customization">
            <h2>üë©‚Äçüè´ For Educators: Adopt & Customize</h2>
            <p style="color: var(--text-secondary); margin-top: 8px;">This comprehensive platform is designed for teachers to adopt, modify, and expand. All content, quizzes, and systems are fully customizable.</p>
            <div class="teacher-controls">
                <button class="teacher-btn" onclick="exportForTeachers()">üì¶ Export Full Package</button>
                <button class="teacher-btn" onclick="showCustomizationGuide()">üìñ Customization Guide</button>
                <button class="teacher-btn" onclick="exportQuizBank()">üß† Download Quiz Bank</button>
                <button class="teacher-btn" onclick="alert('Add your language to the translations object in the code!')">üåê Add Languages</button>
            </div>
        </div>
        
        <div id="modules-container"></div>
    </main>
    
    <footer>
        <div class="footer-content">
            <div style="background: var(--bg-card); padding: var(--spacing-lg); border-radius: 12px; margin-bottom: var(--spacing-lg); border-left: 4px solid var(--accent-success);">
                <h3>üõ°Ô∏è Zero-Harm Educational Commitment</h3>
                <p style="margin-top: 8px; line-height: 1.7;"><strong>Purpose:</strong> This platform exists solely to promote ecological literacy, planetary stewardship, and regenerative practices for current and future generations.</p>
                <p style="margin-top: 8px; line-height: 1.7;"><strong>Non-Weaponization:</strong> No component may be repurposed for surveillance, manipulation, ecological harm, or violation of human rights.</p>
                <p style="margin-top: 8px; line-height: 1.7;"><strong>License:</strong> Educational content under CC BY-SA 4.0. Open source patterns retain original licenses.</p>
            </div>
            <p style="text-align: center; color: var(--text-secondary);">¬© 2025 Planetary Restoration Archive | From Extraction to Stewardship</p>
        </div>
    </footer>
    
    <div class="quiz-modal" id="quiz-modal">
        <div class="quiz-container">
            <div class="quiz-header">
                <h2 id="quiz-title">Practice Quiz</h2>
                <p id="quiz-subtitle" style="margin-top: 8px; opacity: 0.9;"></p>
                <div class="quiz-progress-bar">
                    <div class="quiz-progress-fill" id="quiz-progress"></div>
                </div>
            </div>
            <div class="quiz-body">
                <div id="quiz-questions-container"></div>
                <div class="quiz-results" id="quiz-results">
                    <h2>üéâ Quiz Complete!</h2>
                    <div class="quiz-score" id="quiz-final-score">0%</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 24px 0;">
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                            <div id="quiz-correct" style="font-size: 2rem; font-weight: bold; color: var(--accent-success);">0</div>
                            <div style="color: var(--text-secondary);">Correct</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                            <div id="quiz-incorrect" style="font-size: 2rem; font-weight: bold; color: var(--accent-danger);">0</div>
                            <div style="color: var(--text-secondary);">Incorrect</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                            <div id="quiz-xp-earned" style="font-size: 2rem; font-weight: bold; color: var(--accent-primary);">0</div>
                            <div style="color: var(--text-secondary);">XP Earned</div>
                        </div>
                    </div>
                    <div class="quiz-actions">
                        <button class="quiz-btn-secondary" onclick="closeQuiz()">Close</button>
                        <button class="quiz-btn-primary" onclick="retakeQuiz()">Retake Quiz</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DATABASE SETUP
        let db;
        
        function initDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open('PlanetaryRestorationDB', 1);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('progress')) {
                        db.createObjectStore('progress', { keyPath: 'id' });
                    }
                };
                request.onerror = () => resolve(null);
            });
        }
        
        async function saveProgress(key, value) {
            if (!db) return;
            try {
                const tx = db.transaction(['progress'], 'readwrite');
                tx.objectStore('progress').put({ id: key, value });
            } catch(e) { console.error(e); }
        }
        
        async function loadProgress(key) {
            if (!db) return null;
            try {
                const tx = db.transaction(['progress'], 'readonly');
                const req = tx.objectStore('progress').get(key);
                return new Promise((resolve) => {
                    req.onsuccess = () => resolve(req.result?.value);
                    req.onerror = () => resolve(null);
                });
            } catch(e) { return null; }
        }
        
        // TRANSLATIONS
        const translations = {
            en: {
                'site.title': 'Planetary Restoration Learning System'
            },
            es: {
                'site.title': 'Sistema de Aprendizaje de Restauraci√≥n Planetaria'
            },
            fr: {
                'site.title': 'Syst√®me d\'Apprentissage de Restauration Plan√©taire'
            }
        };
        
        let currentLang = 'en';
        
        function changeLanguage(lang) {
            currentLang = lang;
            renderModules();
        }
        
        // GAMIFICATION SYSTEM
        const gamification = {
            xp: 0,
            level: 1,
            streak: 0,
            completedLessons: [],
            levelIcons: ['üå±', 'üåø', 'üå≥', 'üå≤', 'üå¥', 'üå∏', 'üå∫', 'üåª', 'üåç', 'üåå'],
            
            async init() {
                const saved = await loadProgress('gamification');
                if (saved) Object.assign(this, saved);
                this.updateUI();
            },
            
            addXP(amount) {
                const oldLevel = this.level;
                this.xp += amount;
                
                // Level up at 100, 250, 500, 1000, 2000, 3500, 5000, 7500, 10000
                const levels = [100, 250, 500, 1000, 2000, 3500, 5000, 7500, 10000];
                while (this.level <= levels.length && this.xp >= levels[this.level - 1]) {
                    this.level++;
                }
                
                this.updateUI();
                this.save();
                
                if (this.level > oldLevel) {
                    this.showLevelUp();
                }
            },
            
            updateUI() {
                const levelThresholds = [100, 250, 500, 1000, 2000, 3500, 5000, 7500, 10000, 999999];
                const currentThreshold = levelThresholds[this.level - 1] || 0;
                const nextThreshold = levelThresholds[this.level] || 999999;
                const progress = ((this.xp - currentThreshold) / (nextThreshold - currentThreshold)) * 100;
                
                document.getElementById('xp-fill').style.width = progress + '%';
                document.getElementById('xp-text').textContent = `${this.xp} / ${nextThreshold} XP`;
                document.getElementById('next-level').textContent = `Next: Level ${this.level + 1}`;
                document.getElementById('level-number').textContent = this.level;
                document.getElementById('level-icon').textContent = this.levelIcons[Math.min(this.level - 1, this.levelIcons.length - 1)];
                document.getElementById('streak-days').textContent = `${this.streak} days`;
            },
            
            showLevelUp() {
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center;';
                modal.innerHTML = `
                    <div style="background: var(--bg-card); padding: 48px; border-radius: 24px; text-align: center; border: 3px solid var(--accent-success); max-width: 500px;">
                        <div style="font-size: 6rem; margin-bottom: 16px;">${this.levelIcons[Math.min(this.level - 1, this.levelIcons.length - 1)]}</div>
                        <h2 style="font-size: 2.5rem; margin-bottom: 16px;">Level ${this.level}!</h2>
                        <p style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 32px;">You've grown as an ecological steward!</p>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: var(--accent-success); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 1.1rem; cursor: pointer;">Continue Learning</button>
                    </div>
                `;
                document.body.appendChild(modal);
            },
            
            async save() {
                await saveProgress('gamification', {
                    xp: this.xp,
                    level: this.level,
                    streak: this.streak,
                    completedLessons: this.completedLessons
                });
            }
        };
        
        // COMPREHENSIVE MODULE DATA
        const modules = [
            {
                id: 'soil-regeneration',
                title: 'Soil Regeneration & Carbon Sequestration',
                icon: 'üå±',
                difficulty: 'beginner',
                duration: '45 min',
                xpReward: 50,
                lessons: [
                    {
                        title: 'Understanding Soil Health',
                        content: `
                            <h5>What is Soil Health?</h5>
                            <p>Soil health represents the soil's ability to function as a vital living ecosystem that sustains plants, animals, and humans. Healthy soil contains billions of microorganisms, organic matter, and minerals working together.</p>
                            
                            <div class="implementation-steps">
                                <h5>Key Indicators of Healthy Soil:</h5>
                                <ul>
                                    <li><strong>Soil Structure:</strong> Good aggregation allows water infiltration and root penetration</li>
                                    <li><strong>Organic Matter:</strong> 3-6% organic content supports microbial life</li>
                                    <li><strong>Biological Activity:</strong> Earthworms, fungi, bacteria creating nutrient cycles</li>
                                    <li><strong>Water Holding Capacity:</strong> Ability to retain moisture during dry periods</li>
                                    <li><strong>pH Balance:</strong> Typically 6.0-7.5 for most crops</li>
                                </ul>
                            </div>
                            
                            <h5>The Soil Food Web</h5>
                            <p>The soil food web is an intricate network of organisms that decompose organic matter, cycle nutrients, and create soil structure. Understanding this web is crucial for regenerative practices.</p>
                            
                            <div class="key-terms">
                                <span class="key-term">Mycorrhizae</span>
                                <span class="key-term">Soil Aggregates</span>
                                <span class="key-term">Humus</span>
                                <span class="key-term">Rhizosphere</span>
                            </div>
                        `,
                        quiz: [
                            {
                                question: 'What percentage of organic matter indicates healthy soil?',
                                options: ['0.5-1%', '3-6%', '10-15%', '20-25%'],
                                correct: 1,
                                explanation: 'Healthy agricultural soil typically contains 3-6% organic matter, which supports microbial life and nutrient cycling.'
                            },
                            {
                                question: 'Which organism is most important for nutrient exchange with plant roots?',
                                options: ['Earthworms', 'Mycorrhizal fungi', 'Bacteria', 'Nematodes'],
                                correct: 1,
                                explanation: 'Mycorrhizal fungi form symbiotic relationships with plant roots, extending their reach and exchanging nutrients for carbohydrates.'
                            }
                        ]
                    },
                    {
                        title: 'Composting & Organic Matter',
                        content: `
                            <h5>The Science of Composting</h5>
                            <p>Composting transforms organic waste into nutrient-rich humus through controlled decomposition. This process sequesters carbon, reduces waste, and creates valuable soil amendments.</p>
                            
                            <div class="implementation-steps">
                                <h5>Step-by-Step Composting:</h5>
                                <ol>
                                    <li><strong>Select Location:</strong> Choose a well-drained area with partial shade</li>
                                    <li><strong>Build Base Layer:</strong> 4-6 inches of woody material for aeration</li>
                                    <li><strong>Add Green Materials:</strong> Nitrogen-rich materials (kitchen scraps, grass clippings)</li>
                                    <li><strong>Add Brown Materials:</strong> Carbon-rich materials (leaves, cardboard, straw)</li>
                                    <li><strong>Maintain Ratio:</strong> Aim for 25-30:1 carbon to nitrogen ratio</li>
                                    <li><strong>Monitor Moisture:</strong> Keep as moist as a wrung-out sponge</li>
                                    <li><strong>Turn Regularly:</strong> Every 1-2 weeks to aerate</li>
                                    <li><strong>Harvest:</strong> After 3-6 months when dark and crumbly</li>
                                </ol>
                            </div>
                            
                            <div class="tools-resources">
                                <h5>Tools & Resources:</h5>
                                <ul>
                                    <li>Compost thermometer (monitor microbial activity)</li>
                                    <li>Pitchfork or turning tool</li>
                                    <li>Wire mesh bins or wooden pallets</li>
                                    <li>Resource: <a href="#" class="resource-link">Cornell Composting Guide</a></li>
                                </ul>
                            </div>
                        `
                    }
                ]
            },
            {
                id: 'water-conservation',
                title: 'Water Conservation & Watershed Management',
                icon: 'üíß',
                difficulty: 'intermediate',
                duration: '60 min',
                xpReward: 75,
                lessons: [
                    {
                        title: 'Rainwater Harvesting Systems',
                        content: `
                            <h5>Capturing Nature's Gift</h5>
                            <p>Rainwater harvesting reduces dependence on municipal water, prevents runoff erosion, and recharges groundwater. Every inch of rain on 1,000 sq ft yields approximately 600 gallons.</p>
                            
                            <div class="implementation-steps">
                                <h5>System Components:</h5>
                                <ul>
                                    <li><strong>Catchment Surface:</strong> Roof area (metal or tile preferred)</li>
                                    <li><strong>Gutters & Downspouts:</strong> Channel water to storage</li>
                                    <li><strong>First Flush Diverter:</strong> Removes initial contaminated water</li>
                                    <li><strong>Storage Tanks:</strong> Food-grade containers, sized for rainfall patterns</li>
                                    <li><strong>Overflow Management:</strong> Direct excess to swales or infiltration basins</li>
                                    <li><strong>Distribution System:</strong> Gravity-fed or pump-assisted delivery</li>
                                </ul>
                            </div>
                            
                            <h5>Calculation Formula:</h5>
                            <p style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; font-family: monospace;">
                                Gallons = Roof Area (sq ft) √ó Rainfall (inches) √ó 0.623 √ó 0.9 (efficiency factor)
                            </p>
                        `
                    }
                ]
            },
            {
                id: 'biodiversity',
                title: 'Biodiversity & Ecosystem Restoration',
                icon: 'ü¶ã',
                difficulty: 'intermediate',
                duration: '50 min',
                xpReward: 75,
                lessons: [
                    {
                        title: 'Creating Wildlife Corridors',
                        content: `
                            <h5>Connecting Fragmented Habitats</h5>
                            <p>Wildlife corridors are critical pathways that allow species to move between habitat patches, increasing genetic diversity and resilience to climate change.</p>
                            
                            <div class="implementation-steps">
                                <h5>Corridor Design Principles:</h5>
                                <ul>
                                    <li><strong>Width Matters:</strong> Minimum 100 feet for small mammals, 1 mile for large carnivores</li>
                                    <li><strong>Native Vegetation:</strong> Use region-specific species for food and shelter</li>
                                    <li><strong>Structural Diversity:</strong> Include ground cover, shrubs, and canopy layers</li>
                                    <li><strong>Water Sources:</strong> Integrate ponds, streams, or birdbaths</li>
                                    <li><strong>Minimize Barriers:</strong> Reduce roads, fencing, and human disturbance</li>
                                </ul>
                            </div>
                            
                            <div class="key-terms">
                                <span class="key-term">Edge Effect</span>
                                <span class="key-term">Keystone Species</span>
                                <span class="key-term">Trophic Cascade</span>
                                <span class="key-term">Habitat Fragmentation</span>
                            </div>
                        `
                    }
                ]
            },
            {
                id: 'renewable-energy',
                title: 'Renewable Energy Systems',
                icon: '‚òÄÔ∏è',
                difficulty: 'advanced',
                duration: '75 min',
                xpReward: 100,
                lessons: [
                    {
                        title: 'Solar Power Fundamentals',
                        content: `
                            <h5>Harnessing Solar Energy</h5>
                            <p>Solar photovoltaic (PV) systems convert sunlight directly into electricity. Understanding system design, sizing, and integration is essential for energy independence.</p>
                            
                            <div class="implementation-steps">
                                <h5>System Design Process:</h5>
                                <ol>
                                    <li><strong>Energy Audit:</strong> Calculate daily kWh consumption</li>
                                    <li><strong>Solar Resource Assessment:</strong> Measure peak sun hours for your location</li>
                                    <li><strong>System Sizing:</strong> Daily kWh √∑ Peak Sun Hours √∑ Panel Efficiency</li>
                                    <li><strong>Panel Selection:</strong> Monocrystalline (20-22% efficient) vs Polycrystalline (15-17%)</li>
                                    <li><strong>Inverter Choice:</strong> String, micro, or hybrid systems</li>
                                    <li><strong>Battery Storage:</strong> Lithium-ion vs lead-acid considerations</li>
                                    <li><strong>Grid Integration:</strong> Net metering policies and interconnection</li>
                                </ol>
                            </div>
                            
                            <h5>ROI Calculation:</h5>
                            <p style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                Average payback period: 6-10 years<br>
                                System lifespan: 25-30 years<br>
                                Federal tax credit: 30% (2024-2032)<br>
                                Typical savings: $1,500-$3,000 annually
                            </p>
                        `
                    }
                ]
            },
            {
                id: 'permaculture',
                title: 'Permaculture Design Principles',
                icon: 'üåø',
                difficulty: 'advanced',
                duration: '90 min',
                xpReward: 100,
                lessons: [
                    {
                        title: 'Zone Planning & Design',
                        content: `
                            <h5>The 12 Principles of Permaculture</h5>
                            <p>Permaculture is a holistic design approach that mimics natural ecosystems to create sustainable human habitats.</p>
                            
                            <div class="implementation-steps">
                                <h5>Core Principles:</h5>
                                <ul>
                                    <li><strong>Observe and Interact:</strong> Spend a year observing site before major changes</li>
                                    <li><strong>Catch and Store Energy:</strong> Water harvesting, solar gain, food preservation</li>
                                    <li><strong>Obtain a Yield:</strong> Every element should serve multiple functions</li>
                                    <li><strong>Self-Regulation:</strong> Design systems that maintain themselves</li>
                                    <li><strong>Use Renewable Resources:</strong> Solar, wind, biomass over fossil fuels</li>
                                    <li><strong>Produce No Waste:</strong> All outputs become inputs elsewhere</li>
                                    <li><strong>Design from Patterns to Details:</strong> Work with natural patterns</li>
                                    <li><strong>Integrate Rather than Segregate:</strong> Create beneficial relationships</li>
                                    <li><strong>Use Small, Slow Solutions:</strong> Appropriate scale interventions</li>
                                    <li><strong>Value Diversity:</strong> Polycultures over monocultures</li>
                                    <li><strong>Use Edges:</strong> Most productive areas in ecosystems</li>
                                    <li><strong>Creatively Respond to Change:</strong> Adaptive management</li>
                                </ul>
                            </div>
                            
                            <h5>Zone System (0-5):</h5>
                            <p><strong>Zone 0:</strong> The home - energy efficient design<br>
                            <strong>Zone 1:</strong> Intensive cultivation - herbs, salad greens (daily visits)<br>
                            <strong>Zone 2:</strong> Less intensive - perennials, small livestock (weekly visits)<br>
                            <strong>Zone 3:</strong> Main crops, orchards (occasional visits)<br>
                            <strong>Zone 4:</strong> Semi-wild foraging, timber (seasonal visits)<br>
                            <strong>Zone 5:</strong> Wilderness - observe and learn</p>
                        `
                    }
                ]
            },
            {
                id: 'community',
                title: 'Community Engagement & Action',
                icon: 'ü§ù',
                difficulty: 'beginner',
                duration: '40 min',
                xpReward: 50,
                lessons: [
                    {
                        title: 'Building Local Resilience',
                        content: `
                            <h5>The Power of Community</h5>
                            <p>Individual actions multiply when communities organize around shared ecological goals. Learn to mobilize your neighborhood for lasting change.</p>
                            
                            <div class="implementation-steps">
                                <h5>Community Organizing Steps:</h5>
                                <ol>
                                    <li><strong>Assess Local Needs:</strong> Survey community about environmental priorities</li>
                                    <li><strong>Build Core Team:</strong> 5-10 committed individuals with diverse skills</li>
                                    <li><strong>Set Clear Goals:</strong> SMART objectives (Specific, Measurable, Achievable, Relevant, Time-bound)</li>
                                    <li><strong>Create Action Plan:</strong> Timeline, responsibilities, resources needed</li>
                                    <li><strong>Engage Stakeholders:</strong> Local government, schools, businesses</li>
                                    <li><strong>Launch Pilot Project:</strong> Start small to build momentum</li>
                                    <li><strong>Document Success:</strong> Photos, metrics, testimonials</li>
                                    <li><strong>Scale and Replicate:</strong> Share learnings with other communities</li>
                                </ol>
                            </div>
                            
                            <div class="tools-resources">
                                <h5>Project Ideas:</h5>
                                <ul>
                                    <li>Community gardens and food forests</li>
                                    <li>Tool libraries and repair cafes</li>
                                    <li>Native plant nurseries</li>
                                    <li>Composting cooperatives</li>
                                    <li>Seed saving exchanges</li>
                                    <li>Renewable energy buying clubs</li>
                                </ul>
                            </div>
                        `
                    }
                ]
            }
        ];
        
        // QUIZ SYSTEM
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let quizAnswers = [];
        
        function startQuiz(moduleId, lessonIndex) {
            const module = modules.find(m => m.id === moduleId);
            const lesson = module.lessons[lessonIndex];
            
            if (!lesson.quiz || lesson.quiz.length === 0) {
                alert('No quiz available for this lesson yet!');
                return;
            }
            
            currentQuiz = {
                moduleId,
                lessonIndex,
                questions: lesson.quiz,
                moduleTitle: module.title,
                lessonTitle: lesson.title
            };
            currentQuestionIndex = 0;
            quizAnswers = [];
            
            document.getElementById('quiz-modal').classList.add('active');
            document.getElementById('quiz-title').textContent = module.title;
            document.getElementById('quiz-subtitle').textContent = lesson.title;
            document.getElementById('quiz-results').classList.remove('show');
            
            renderQuestion();
        }
        
        function renderQuestion() {
            const question = currentQuiz.questions[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
            document.getElementById('quiz-progress').style.width = progress + '%';
            
            const container = document.getElementById('quiz-questions-container');
            container.innerHTML = `
                <div>
                    <div style="margin-bottom: 16px; color: var(--text-secondary);">
                        Question ${currentQuestionIndex + 1} of ${currentQuiz.questions.length}
                    </div>
                    <div class="question-text">${question.question}</div>
                    <div class="quiz-options">
                        ${question.options.map((opt, i) => `
                            <div class="quiz-option" data-index="${i}" onclick="selectAnswer(${i})">
                                ${opt}
                            </div>
                        `).join('')}
                    </div>
                    <div class="quiz-feedback" id="quiz-feedback"></div>
                    <div class="quiz-actions">
                        ${currentQuestionIndex > 0 ? '<button class="quiz-btn-secondary" onclick="previousQuestion()">‚Üê Previous</button>' : '<div></div>'}
                        <button class="quiz-btn-primary" id="quiz-next-btn" onclick="nextQuestion()" disabled>
                            ${currentQuestionIndex < currentQuiz.questions.length - 1 ? 'Next Question ‚Üí' : 'Finish Quiz'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        function selectAnswer(index) {
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(opt => opt.classList.remove('selected'));
            options[index].classList.add('selected');
            
            quizAnswers[currentQuestionIndex] = index;
            document.getElementById('quiz-next-btn').disabled = false;
            
            const question = currentQuiz.questions[currentQuestionIndex];
            const feedback = document.getElementById('quiz-feedback');
            const isCorrect = index === question.correct;
            
            options.forEach(opt => opt.classList.add('disabled'));
            options[index].classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                options[question.correct].classList.add('correct');
            }
            
            feedback.className = 'quiz-feedback show ' + (isCorrect ? 'correct' : 'incorrect');
            feedback.innerHTML = `
                <strong>${isCorrect ? '‚úÖ Correct!' : '‚ùå Not quite.'}</strong><br>
                ${question.explanation}
            `;
        }
        
        function nextQuestion() {
            if (quizAnswers[currentQuestionIndex] === undefined) return;
            
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                showResults();
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        }
        
        function showResults() {
            const correct = quizAnswers.filter((ans, i) => ans === currentQuiz.questions[i].correct).length;
            const total = currentQuiz.questions.length;
            const percentage = Math.round((correct / total) * 100);
            
            let xpEarned = 0;
            if (percentage >= 80) xpEarned = 75;
            else if (percentage >= 60) xpEarned = 50;
            else if (percentage >= 40) xpEarned = 25;
            
            gamification.addXP(xpEarned);
            
            document.getElementById('quiz-questions-container').style.display = 'none';
            document.getElementById('quiz-results').classList.add('show');
            document.getElementById('quiz-final-score').textContent = percentage + '%';
            document.getElementById('quiz-correct').textContent = correct;
            document.getElementById('quiz-incorrect').textContent = total - correct;
            document.getElementById('quiz-xp-earned').textContent = xpEarned;
        }
        
        function retakeQuiz() {
            document.getElementById('quiz-questions-container').style.display = 'block';
            currentQuestionIndex = 0;
            quizAnswers = [];
            renderQuestion();
        }
        
        function closeQuiz() {
            document.getElementById('quiz-modal').classList.remove('active');
            currentQuiz = null;
        }
        
        // MODULE RENDERING
        function renderModules(filter = 'all', searchTerm = '') {
            const container = document.getElementById('modules-container');
            let filtered = modules;
            
            if (filter !== 'all') {
                filtered = modules.filter(m => m.difficulty === filter);
            }
            
            if (searchTerm) {
                searchTerm = searchTerm.toLowerCase();
                filtered = filtered.filter(m => 
                    m.title.toLowerCase().includes(searchTerm) ||
                    m.lessons.some(l => 
                        l.title.toLowerCase().includes(searchTerm) ||
                        l.content.toLowerCase().includes(searchTerm)
                    )
                );
            }
            
            container.innerHTML = filtered.map(module => `
                <div class="module" data-difficulty="${module.difficulty}" data-id="${module.id}">
                    <div class="module-header" onclick="toggleModule('${module.id}')">
                        <div class="module-title">
                            <div class="module-icon">${module.icon}</div>
                            <div>
                                <h3>${module.title}</h3>
                                <div class="module-meta">
                                    <span>üìö ${module.lessons.length} Lessons</span>
                                    <span>‚è±Ô∏è ${module.duration}</span>
                                    <span>‚≠ê ${module.xpReward} XP</span>
                                    <span style="text-transform: capitalize;">üéØ ${module.difficulty}</span>
                                </div>
                            </div>
                        </div>
                        <div class="chevron">‚ñº</div>
                    </div>
                    <div class="module-content">
                        <div class="module-body">
                            ${module.lessons.map((lesson, idx) => `
                                <div class="lesson">
                                    <h4>${lesson.title}</h4>
                                    ${lesson.content}
                                    ${lesson.quiz ? `<button class="quiz-btn" onclick="startQuiz('${module.id}', ${idx})">üß† Take Practice Quiz</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleModule(moduleId) {
            const module = document.querySelector(`.module[data-id="${moduleId}"]`);
            module.classList.toggle('expanded');
        }
        
        function filterModules(difficulty) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderModules(difficulty, document.getElementById('search-input').value);
        }
        
        // SEARCH
        document.getElementById('search-input').addEventListener('input', (e) => {
            const activeFilter = document.querySelector('.nav-btn.active');
            const difficulty = activeFilter ? activeFilter.textContent.toLowerCase().replace('modules', '').trim() : 'all';
            renderModules(difficulty === '' ? 'all' : difficulty, e.target.value);
        });
        
        // EXPORT FUNCTIONS
        function exportHTML() {
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'planetary-restoration-learning-system.html';
            a.click();
        }
        
        function exportForTeachers() {
            alert('Exporting complete package with:\n‚Ä¢ Full HTML source\n‚Ä¢ Module content\n‚Ä¢ Quiz bank\n‚Ä¢ Customization guide\n‚Ä¢ Asset library');
        }
        
        function showCustomizationGuide() {
            alert('CUSTOMIZATION GUIDE:\n\n1. Edit modules array to add/modify content\n2. Add new quiz questions in lesson.quiz arrays\n3. Customize colors in :root CSS variables\n4. Add languages in translations object\n5. Modify XP/leveling in gamification object\n6. All code is open and documented');
        }
        
        function exportQuizBank() {
            const quizData = modules.flatMap(m => 
                m.lessons.filter(l => l.quiz).map(l => ({
                    module: m.title,
                    lesson: l.title,
                    questions: l.quiz
                }))
            );
            const json = JSON.stringify(quizData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quiz-bank.json';
            a.click();
        }
        
        // CONSTELLATION BACKGROUND
        const canvas = document.getElementById('constellation-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];
        
        function initConstellation() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            stars = Array.from({ length: 150 }, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2,
                speedX: (Math.random() - 0.5) * 0.2,
                speedY: (Math.random() - 0.5) * 0.2,
                opacity: Math.random() * 0.5 + 0.3
            }));
            
            animateConstellation();
        }
        
        function animateConstellation() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Update and draw stars
            stars.forEach(star => {
                star.x += star.speedX;
                star.y += star.speedY;
                
                if (star.x < 0) star.x = canvas.width;
                if (star.x > canvas.width) star.x = 0;
                if (star.y < 0) star.y = canvas.height;
                if (star.y > canvas.height) star.y = 0;
                
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(147, 197, 253, ${star.opacity})`;
                ctx.fill();
            });
            
            // Draw connections
            stars.forEach((star, i) => {
                stars.slice(i + 1).forEach(otherStar => {
                    const dx = star.x - otherStar.x;
                    const dy = star.y - otherStar.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 100) {
                        ctx.beginPath();
                        ctx.moveTo(star.x, star.y);
                        ctx.lineTo(otherStar.x, otherStar.y);
                        ctx.strokeStyle = `rgba(147, 197, 253, ${0.15 * (1 - distance / 100)})`;
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                    }
                });
            });
            
            requestAnimationFrame(animateConstellation);
        }
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // INITIALIZATION
        async function init() {
            await initDB();
            await gamification.init();
            renderModules();
            initConstellation();
            
            // Check daily streak
            const lastVisit = await loadProgress('lastVisit');
            const today = new Date().toDateString();
            
            if (lastVisit !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastVisit === yesterday.toDateString()) {
                    gamification.streak++;
                    gamification.addXP(25);
                } else if (lastVisit) {
                    gamification.streak = 1;
                } else {
                    gamification.streak = 1;
                }
                
                await saveProgress('lastVisit', today);
                gamification.save();
            }
        }
        
        // Start the application
        init();
    </script>
</body>
</html>
